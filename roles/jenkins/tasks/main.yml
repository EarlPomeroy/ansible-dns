---
- name: Configure APT for Jenkins install
  tags: jenkins
  block:
    - name: Get Jenkins GPG key
      tags: jenkins
      ansible.builtin.apt_key:
        url: https://pkg.jenkins.io/debian/jenkins.io-2023.key
        state: present

    - name: Add Jenkins repo
      tags: jenkins
      ansible.builtin.apt_repository:
        repo: "deb https://pkg.jenkins.io/debian binary/"
        state: present
        filename: jenkins

- name: Update APT cache
  tags: jenkins
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Create Jenkins user and generate a 4096 bit SSH key
  tags: jenkins
  ansible.builtin.user:
    name: jenkins
    generate_ssh_key: true
    ssh_key_bits: 4096
    ssh_key_file: .ssh/id_rsa
    ssh_key_comment: jenkins

- name: Install Jenkins
  tags: jenkins
  ansible.builtin.apt:
    pkg:
      - git
      - jenkins
      - default-jdk-headless

- name: Enable and start Jenkins service
  tags: jenkins
  ansible.builtin.systemd:
    name: jenkins
    state: started
    enabled: true

- name: Configure Nginx for Jenkins
  tags: jenkins
  ansible.builtin.template:
    src: jenkins.conf.j2
    dest: /etc/nginx/conf.d/jenkins.conf
    owner: root
    group: root
    mode: 0644
  notify: Restart Nginx
