---
- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install NFS Server
  ansible.builtin.apt:
    pkg:
      - nfs-kernel-server

- name: Enable and start NFS Server
  ansible.builtin.systemd:
    name: nfs-kernel-server
    enabled: true
    state: started

- name: Create NFS directories
  ansible.builtin.file:
    path: "{{ item.value['path'] }}"
    state: directory
    mode: 0777
  loop: "{{ nfs_shares | dict2items }}"

- name: Setup NFS mount points
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
    owner: root
    group: root
    mode: 0644
  notify:
    - Export NFS mount points
    - Restart NFS Server
